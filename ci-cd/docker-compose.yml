services:

  postgres:
    image: postgres
    restart: always
    ports:
      - 127.0.0.1:5432:5432
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    networks:
      ci_network:
    volumes:
      - postgres_data:/var/lib/postgresql/data

  jenkins-blueocean:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: jenkins-blueocean
    restart: on-failure
    networks:
      ci_network:
    environment: 
      - DOCKER_HOST=unix:///var/run/docker.sock
    ports:
      - "127.0.0.1:49000:8080"
    volumes:
      - jenkins-data:/var/jenkins_home
      - jenkins-docker-certs:/certs/client:ro
      - /var/run/docker.sock:/var/run/docker.sock # < Docker de l'hÃ´te
  
  jenkins-agent-unbound:
    build:
      context: ./jenkins/agents/jenkins-unbound
      dockerfile: Dockerfile
    container_name: jenkins-agent-unbound
    restart: on-failure
    user: "jenkins:994"
    networks:
      ci_network:
    environment:
      - JENKINS_URL=http://jenkins-blueocean:8080/
      - JENKINS_AGENT_NAME=java_agent
      - JENKINS_SECRET=a5628744e0018bbad931ab25cfabbcdbb50b8f9894558c72a2a8eff980d4e922
      - JENKINS_WORKDIR=/home/jenkins/agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    group_add:
      - docker
  sonarqube:
    image: sonarqube:latest
    container_name: sonarqube
    restart: always
    ports:
      - "127.0.0.1:9000:9000"
    environment:
      - SONAR_JDBC_URL=${SONAR_JDBC_URL}
      - SONAR_JDBC_USERNAME=${SONAR_JDBC_USER}
      - SONAR_JDBC_PASSWORD=${SONAR_JDBC_PASSWORD}
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=${SONAR_ES_BOOTSTRAP_CHECKS_DISABLE}    
    networks:
      - ci_network

    volumes:
      - "sonarqube_data:/opt/sonarqube/data"
      - "sonarqube_extensions:/opt/sonarqube/extensions"
      - "sonarqube_logs:/opt/sonarqube/logs"
  
  registry:
    image: registry:2
    container_name: registry
    restart: always
    networks:
      - ci_network
    ports:
      - "127.0.0.1:5050:5000"
    volumes:
      - registry-data:/var/lib/registry
      - ./registry/config.yml:/etc/docker/registry/config.yml

networks:
  ci_network:
    external: true

volumes:
  postgres_data:
  jenkins-docker-certs:
    name: dev-ops_jenkins-docker-certs
  jenkins-data:
    name: dev-ops_jenkins-data
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  registry-data:
    driver: local
