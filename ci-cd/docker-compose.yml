services:
  jenkins:
    image: docker:dind
    container_name: jenkins-docker
    restart: always
    privileged: true
    ports:
      - "127.0.0.1:2376:2376"
    environment:
      - DOCKER_TLS_CERTDIR=${JENKINS_DOCKER_TLS_CERTDIR}
    networks:
      ci_network:
        aliases:
          - docker
    volumes:
      - "jenkins-docker-certs:/certs/client"
      - "jenkins-data:/var/jenkins_home"
    command: ["--storage-driver", "overlay2"]

  jenkins-blueocean:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: jenkins-blueocean
    restart: on-failure
    networks:
      ci_network:
    environment:
      - DOCKER_HOST=${JENKINS_DOCKER_HOST} 
      - DOCKER_CERT_PATH=${JENKINS_DOCKER_CERT_PATH}
      - DOCKER_TLS_VERIFY=${JENKINS_DOCKER_TLS_VERIFY}
    ports:
      - "127.0.0.1:49000:8080"
    volumes:
      - jenkins-data:/var/jenkins_home
      - jenkins-docker-certs:/certs/client:ro
  
  sonarqube:
    image: sonarqube:latest
    container_name: sonarqube
    restart: always
    ports:
      - "127.0.0.1:9000:9000"
    environment:
      - SONAR_JDBC_URL=${SONAR_JDBC_URL}
      - SONAR_JDBC_USERNAME=${SONAR_JDBC_USER}
      - SONAR_JDBC_PASSWORD=${SONAR_JDBC_PASSWORD}
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=${SONAR_ES_BOOTSTRAP_CHECKS_DISABLE}    
    networks:
      - ci_network

    volumes:
      - "sonarqube_data:/opt/sonarqube/data"
      - "sonarqube_extensions:/opt/sonarqube/extensions"
      - "sonarqube_logs:/opt/sonarqube/logs"
  
  registry:
    image: registry:2
    container_name: registry
    restart: always
    networks:
      - ci_network
    ports:
      - "127.0.0.1:5050:5000"
    volumes:
      - registry-data:/var/lib/registry
      - ./registry/config.yml:/etc/docker/registry/config.yml

networks:
  ci_network:
    external: true

volumes:
  jenkins-docker-certs:
  jenkins-data:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  registry-data:
    driver: local
